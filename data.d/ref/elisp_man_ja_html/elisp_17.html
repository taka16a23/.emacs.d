<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">
<!-- Created on October, 1  2005 by texi2html 1.64 -->
<!-- 
Written by: Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Olaf Bachmann <obachman@mathematik.uni-kl.de>
Send bugs and suggestions to <texi2html@mathematik.uni-kl.de>
 
-->
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html;CHARSET=euc-jp">
<META NAME="keywords" CONTENT="meadow,mule,emacs,lisp,elisp,gnus,setting,設定,unix,cygwin">
<META http-equiv="Content-Script-Type" content="text/javascript">
<META NAME="description" CONTENT="Meadowの設定を紹介するページです">
<TITLE>GNU Emacs Lispリファレンスマニュアル:  Emacs Lisp関数のアドバイス</TITLE>

<META NAME="description" CONTENT="GNU Emacs Lispリファレンスマニュアル:  Emacs Lisp関数のアドバイス">
<META NAME="keywords" CONTENT="GNU Emacs Lispリファレンスマニュアル:  Emacs Lisp関数のアドバイス">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<META NAME="Generator" CONTENT="texi2html 1.64">

<LINK REL="contents" HREF="elisp_toc.html#SEC_Contents">
<LINK REL="index" HREF="elisp_48.html#SEC681">
<LINK REL="next" HREF="elisp_18.html#SEC219">
<LINK REL="prev" HREF="elisp_16.html#SEC200">

<META http-equiv="Content-Style-Type" content="text/css">
<!-- 鶯と龜 ←日本語EUC誤判別対策用らしい; -->
<link rel="StyleSheet" href="../../../../soft/css/midnight.css" type="text/css" id="css1">
<script type="text/javascript" src="style1.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../soft/css/meadowmemo.css">

</HEAD>
<BODY LANG="ja" BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#0000FF" VLINK="#800080" ALINK="#FF0000">
<!--Infoseek Analyzer start-->
<script LANGUAGE="javascript">PgNo=6;</script>
<script src="http://js1.infoseek.co.jp/bin/57/00170.js"></script>
<noscript><a href="http://ax1.www.infoseek.co.jp/bin/go?0017057f" target="_blank">
<img src="http://ax1.www.infoseek.co.jp/bin/logo?0017057f" border=0></a></noscript>
<!--Infoseek Analyzer end-->
<a name="top"> </a>

<br><A NAME="SEC208"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_16.html#SEC207"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC209"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_16.html#SEC200"> &lt;&lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_18.html#SEC219"> &gt;&gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Advising Functions"></A>
<H1> 16. Emacs Lisp関数のアドバイス <EM>(2003/10/30)</EM> </H1>
<!--docid::SEC208::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Advising%20Functions">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Advising%20Functions</a>"<br>
"texi/elisp21/EmacsLisp関数のアドバイス"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2FEmacsLisp%B4%D8%BF%F4%A4%CE%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<A NAME="IDX786"></A>
<P>

<EM>アドバイス</EM>（advice）機能により、関数の既存の定義に追加できます。
これは、Emacsの他の部分で定義された関数を
ライブラリにおいてカスタマイズする見通しのよい方法です。
関数全体を再定義するよりも見通しがよいのです。
<P>

<A NAME="IDX787"></A>
各関数は、個別に定義した複数の<EM>アドバイス断片</EM>を持てます。
それぞれのアドバイス断片は、明示的に<EM>有効</EM>にしたり無効にできます。
任意の関数で有効にされたすべてのアドバイス断片が実際にその効果を発揮するのは、
当該関数のアドバイスを<EM>活性にした</EM>ときか
当該関数を定義したり再定義したときです。ここで、アドバイス断片を「有効にする
こと」と「活性にすること」は同じことでないので注意が必要です。
<P>

<STRONG>使用上の注意：</STRONG><CODE> </CODE>
アドバイスは、既存関数の既存の呼び出しのふるまいを変更するのに有用である。
新たな呼び出しやキーバインドの新たなふるまいが必要な場合には、
既存関数を使う新たな関数（や新たなコマンド）を定義するほうが
見通しがよい。
<P>

<div class="menuindex"><SCRIPT language=JavaScript src="index16.js"></SCRIPT></div><noscript><BLOCKQUOTE><TABLE BORDER=0 CELLSPACING=0> 
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC209">16.1 単純なアドバイスの例 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">A simple example to explain the basics of advice.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC210">16.2 アドバイス定義 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">Detailed description of <CODE>defadvice</CODE>.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC211">16.3 包囲アドバイス <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">Wrapping advice around a function's definition.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC212">16.4 計算アドバイス <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">...is to <CODE>defadvice</CODE> as <CODE>fset</CODE> is to <CODE>defun</CODE>.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC213">16.5 アドバイスの活性化 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">Advice doesn't do anything until you activate it.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC214">16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">You can enable or disable each piece of advice.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC215">16.7 予約活性 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">Preactivation is a way of speeding up the
                              loading of compiled advice.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC216">16.8 アドバイスからの引数の参照 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">How advice can access the function's arguments.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC217">16.9 subr引数リストの定義 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">Accessing arguments when advising a primitive.</TD></TR>
<TR><TD ALIGN="left" VALIGN="TOP"><A HREF="elisp_17.html#SEC218">16.10 結合定義 <EM>(2003/10/30)</EM></A></TD><TD>&nbsp;&nbsp;</TD><TD ALIGN="left" VALIGN="TOP">How advice is implemented.</TD></TR>
</TABLE></BLOCKQUOTE></noscript>
<P>

<A NAME="Simple Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC209"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC208"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC210"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Simple Advice"></A>
<H2> 16.1 単純なアドバイスの例 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC209::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Simple%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Simple%20Advice</a>"<br>
"texi/elisp21/単純なアドバイスの例"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%C3%B1%BD%E3%A4%CA%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9%A4%CE%CE%E3">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

コマンド<CODE>next-line</CODE>は、ポイントを垂直に複数行移動します。
標準バインドは<KBD>C-n</KBD>です。
バッファの最終行で使うと、
<CODE>next-line-add-newlines</CODE>が<CODE>nil</CODE>以外の場合(デフォルトは<CODE>nil</CODE>)
このコマンドは行を作るために改行を挿入し、その行に移動します。
<P>

同様な機能を<CODE>previous-line</CODE>に追加したいとします。
つまり、バッファの先頭に新たな行を挿入し、その行へ移動するのです。
どのようにすればよいでしょう？
<P>

当該関数を再定義すればできますが、それではモジュール性がよくありません。
アドバイス機能が見通しのよい代替方法を提供します。
既存の関数定義を実際に変更したりその定義を参照することなく、
関数定義に読者のコードを実質的に追加できます。
つぎのように行います。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(defadvice previous-line (before next-line-at-end (arg))
  "Insert an empty line when moving up from the top line."
  (if (and next-line-add-newlines (= arg 1)
           (save-excursion (beginning-of-line) (bobp)))
      (progn
        (beginning-of-line)
        (newline))))
</pre></td></tr></table><P>

この式は、関数<CODE>previous-line</CODE>に対する<EM>アドバイス断片</EM>を定義します。
このアドバイス断片には<CODE>next-line-at-end</CODE>という名前が付きます。
シンボル<CODE>before</CODE>により、
<CODE>previous-line</CODE>の通常の定義を実行するまえに実行する
<EM>事前アドバイス</EM>（before-advice）であることを意味します。
<CODE>(arg)</CODE>は、アドバイス断片がどのように関数の引数を参照するかを指定します。
<P>

このアドバイス断片が実行されると、必要な場面では新たに行を作りますが、
その行へはポイントを移動しません。
これはアドバイスを書く正しいやりかたです。
というのは、通常の定義がこのあとに実行され、新たに挿入した行へ移動します。
<P>

アドバイスを定義しても関数<CODE>previous-line</CODE>をただちには変更しません。
つぎのようにアドバイスを<EM>活性にする</EM>と変わります。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-activate 'previous-line)
</pre></td></tr></table><P>

これにより、関数<CODE>previous-line</CODE>に対して定義してある
アドバイスを使い始めます。
これ以降、<KBD>C-p</KBD>や<KBD>M-x</KBD>でユーザーが起動したのか
Lispから呼ばれたのかに関わらず、
この関数を起動すると、まずアドバイスを実行してから
関数の通常の定義を実行します。
<P>

この例は、アドバイスの1つの<EM>クラス</EM>である事前アドバイスの例であり、
関数の元定義のまえに実行されます。
他に2つのアドバイスクラスがあります。
元定義のあとに実行される<EM>事後アドバイス</EM>（after-advice）と
元定義の起動を包み込む式を指定する<EM>包囲アドバイス</EM>（around-advice）です。
<P>

<A NAME="Defining Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC210"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC209"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC211"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Defining Advice"></A>
<H2> 16.2 アドバイス定義 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC210::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Defining%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Defining%20Advice</a>"<br>
"texi/elisp21/アドバイス定義"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9%C4%EA%B5%C1">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<A NAME="IDX788"></A>
<A NAME="IDX789"></A>
<P>

アドバイス断片を定義するには、マクロ<CODE>defadvice</CODE>を使います。
<CODE>defadvice</CODE>の呼び出しはつぎのような構文です。
<CODE>defun</CODE>や<CODE>defmacro</CODE>の構文を基にしていますが、
追加部分があります。
<P>

<A NAME="IDX790"></A>
<TABLE><tr><td>&nbsp;</td><td class=example><pre>(defadvice <VAR>function</VAR> (<VAR>class</VAR> <VAR>name</VAR>
                         [<VAR>position</VAR>] [<VAR>arglist</VAR>]
                         <VAR>flags</VAR>...)
  [<VAR>documentation-string</VAR>]
  [<VAR>interactive-form</VAR>]
  <VAR>body-forms</VAR>...)
</pre></td></tr></table><P>

ここで、<VAR>function</VAR>はアドバイス対象となる関数
（やマクロやスペシャルフォーム）です。
以後、アドバイスする対象を単に『関数』と書きますが、
これにはつねにマクロやスペシャルフォームを含みます。
<P>

<A NAME="IDX791"></A>
<A NAME="IDX792"></A>
<A NAME="IDX793"></A>
<A NAME="IDX794"></A>
<A NAME="IDX795"></A>
<A NAME="IDX796"></A>
<A NAME="IDX797"></A>
<A NAME="IDX798"></A>
<VAR>class</VAR>はアドバイスの<EM>クラス</EM>を指定し、
<CODE>before</CODE>、<CODE>after</CODE>、<CODE>around</CODE>のいずれかです。
事前アドバイス（<CODE>before</CODE>）は関数そのもののまえに実行されます。
事後アドバイス（<CODE>after</CODE>）は関数そのもののあとに実行されます。
包囲アドバイス（<CODE>around</CODE>）は関数自身の実行を包み込みます。
事後アドバイスと包囲アドバイスでは、
<CODE>ad-return-value</CODE>に設定することで戻り値を変更できます。
<P>

<A NAME="IDX799"></A>
<DL>
<DT><U>Variable:</U> <B>ad-return-value</B>
<DD>アドバイスを実行しているとき、
関数の元定義の実行を完了したあとでは、この変数はその戻り値を保持する。
すべてのアドバイスを完了すると、最終的には、この値を呼び出し側へ返す。
事後アドバイスと包囲アドバイスでは、この変数に別の値を設定することで
戻り値を変更できる。
</DL>
<P>

引数<VAR>name</VAR>はアドバイスの名前であり、<CODE>nil</CODE>以外のシンボルです。
アドバイス名は、<VAR>function</VAR>の特定クラスのすべてのアドバイス断片から
1つのアドバイス断片を一意に識別します。
名前でアドバイス断片を参照でき、
それを再定義したり有効にしたり無効にできます。
<P>

通常の関数定義の引数リストのかわりに、
アドバイス定義では異なる情報を必要とします。
<P>

省略可能な<VAR>position</VAR>は、指定した<VAR>class</VAR>の
現在のアドバイスリストのどこに新たなアドバイスを置くかを指定します。
<CODE>first</CODE>、<CODE>last</CODE>、あるいは、
0から数え始める位置を指定する数である必要があります
（<CODE>first</CODE>は0と等価）。
位置を指定しないとデフォルトは<CODE>first</CODE>です。
当該クラスの既存位置の範囲を超えている場合には、
先頭か末尾のどちらか近いほうになります。
既存のアドバイス断片を再定義する場合には、値<VAR>position</VAR>は無視されます。
<P>

省略可能な<VAR>arglist</VAR>は、
アドバイスが使う引数リストを定義するために使います。
これは、アドバイスを実行するために生成される結合定義
（see 節 <A HREF="elisp_17.html#SEC218">16.10 結合定義 <EM>(2003/10/30)</EM></A>）の引数リストになります。
その結果、アドバイスの式では、
引数の値を参照するためにこのリストの引数変数を使えます。
<P>

この引数リストは、関数の実際の呼び出し方を扱えるように、
もとの関数の引数リストと互換性がある必要があります。
2つ以上のアドバイス断片で引数リストを指定している場合、
すべてのアドバイスクラスの中で最初のもの（位置が最小のもの）を使います。
<P>

残りの要素<VAR>flags</VAR>は、このアドバイス断片の使い方に関する情報を指定する
シンボルです。
正しいシンボルとそれらの意味はつぎのとおりです。
<P>

<DL COMPACT>
<DT><CODE>activate</CODE>
<DD><VAR>function</VAR>に対するアドバイスをただちに活性にする。
関数のアドバイスに対する変更は、当該関数のアドバイスを活性にすると
効果を持つようになる。
このフラグは、<VAR>function</VAR>に対するこのアドバイス断片を定義した直後に
そのようにすることを指示する。
<P>

<A NAME="IDX800"></A>
<VAR>function</VAR>が未定義（<EM>未定義のアドバイス</EM>（forward advice）と呼ぶ状況）
であるとこのフラグがすぐに効果を表すことはない。
というのは、未定義関数のアドバイスは活性にできないからである。
しかし、<VAR>function</VAR>を定義するとそのアドバイスは自動的に活性にされる。
<P>

<DT><CODE>protect</CODE>
<DD>このアドバイス断片をそれよりまえに実行されるコードやアドバイスによる
非ローカル脱出やエラーに対して保護する。
保護したアドバイス断片は、
フォーム<CODE>unwind-protect</CODE>の中に後始末として置かれ、
それよりまえに実行されるコードでエラーが発生したり<CODE>throw</CODE>を使っても
実行される。
see 節 <A HREF="elisp_10.html#SEC135">9.5.4 非ローカル脱出時の後始末</A>。
<P>

<DT><CODE>compile</CODE>
<DD>アドバイスの実行に使われる結合定義をコンパイルする。
<CODE>activate</CODE>とともに指定しないと、このフラグは無視する。
see 節 <A HREF="elisp_17.html#SEC218">16.10 結合定義 <EM>(2003/10/30)</EM></A>。
<P>

<DT><CODE>disable</CODE>
<DD>このアドバイス断片を当初は無効にしておき、
のちに明示的に有効にしない限り使われない。
see 節 <A HREF="elisp_17.html#SEC214">16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM></A>。
<P>

<DT><CODE>preactivate</CODE>
<DD>この<CODE>defadvice</CODE>をコンパイルしたりマクロ展開したときに、
<VAR>function</VAR>に対するアドバイスを活性にする。
これにより現在のアドバイスの状態に応じたアドバイス定義をコンパイルし、
必要に応じて使われるようになる。See 節 <A HREF="elisp_17.html#SEC215">16.7 予約活性 <EM>(2003/10/30)</EM></A>。
<P>

この<CODE>defadvice</CODE>をバイトコンパイルする場合にのみ意味を持つ。
</DL>
<P>

省略可能な<VAR>documentation-string</VAR>は、
このアドバイス断片の説明文字列になります。
<VAR>function</VAR>に対するアドバイスが活性であると、
（<CODE>documentation</CODE>が返す）<VAR>function</VAR>の説明文は、
関数の元定義の説明文字列と<VAR>function</VAR>のアドバイスすべての説明文字列の
合成になります。
<P>

省略可能な<VAR>interactive-form</VAR>は、
元関数の対話的ふるまいを変更するために指定します。
2つ以上のアドバイス断片で<VAR>interactive-form</VAR>を指定している場合、
すべてのアドバイスの中で最初のもの（位置が最小のもの）が優先します。
<P>

空リストでもかまわない<VAR>body-forms</VAR>は、アドバイスの本体です。
アドバイスの本体では、引数、戻り値、束縛環境を参照／変更したり、
いかなる種類の副作用を起こせます。
<P>

<STRONG>警告：</STRONG><CODE> </CODE>
マクロをアドバイスする場合、
マクロはプログラムのコンパイル時に展開されるのであって、
コンパイルしたプログラムの実行時に展開されるのではないことに注意。
アドバイスが使用するすべてのサブルーティンは、
バイトコンパイラがマクロを展開するときに必要になる。
<P>

<A NAME="IDX801"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-unadvise</B> <I>function</I>
<DD>このコマンドは<VAR>function</VAR>からアドバイスを削除する。
</DL>
<P>

<A NAME="IDX802"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-unadvise-all</B>
<DD>このコマンドはすべての関数からすべてのアドバイス断片を削除する。
</DL>
<P>

<A NAME="Around-Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC211"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC210"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC212"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Around-Advice"></A>
<H2> 16.3 包囲アドバイス <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC211::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Around-Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Around-Advice</a>"<br>
"texi/elisp21/包囲アドバイス"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%CA%F1%B0%CF%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

包囲アドバイスにより、関数の元定義を包み込むLisp式を書けます。
関数の元定義を実行する場所を特別なシンボル<CODE>ad-do-it</CODE>で指定します。
包囲アドバイスの本体に現れたこのシンボルは、
元定義（と内側の包囲アドバイス本体）のフォームを含んだ<CODE>progn</CODE>で
置き換えられます。
例を示しましょう。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(defadvice foo (around foo-around)
  "Ignore case in `foo'."
  (let ((case-fold-search t))
    ad-do-it))
</pre></td></tr></table><P>

これは、<CODE>foo</CODE>の元定義を実行するときに
大文字小文字を区別しないで探索することを保証します。
<P>

<A NAME="IDX803"></A>
<DL>
<DT><U>Variable:</U> <B>ad-do-it</B>
<DD>これは実際には変数ではないが、包囲アドバイス内では変数のように用いる。
関数の元定義と『より内側の』包囲アドバイスを実行する場所を指定する。
</DL>
<P>

包囲アドバイスで<CODE>ad-do-it</CODE>を用いなければ、関数の元定義を実行しません。
これは、元定義を完全に無効にする手段です。
（さらに、内側の包囲アドバイス断片も無効にする）
<P>

もし包囲アドバイスが<CODE>ad-do-it</CODE>を1つ以上用いていれば、関数の元定義
がそれぞれの場所で実行される。これにより、包囲アドバイスは元の関数(と
その中の関数に含まれる包囲アドバイス断片)を何度も実行できる。このよう
に、元の関数を複数回実行するには、ループの中で<CODE>ad-do-it</CODE>を用いて
も可能である。
<P>

<A NAME="Computed Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC212"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC211"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC213"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Computed Advice"></A>
<H2> 16.4 計算アドバイス <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC212::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Computed%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Computed%20Advice</a>"<br>
"texi/elisp21/計算アドバイス"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%B7%D7%BB%BB%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

マクロ<CODE>defadvice</CODE>は<CODE>defun</CODE>に似ていて、
アドバイスのコードやアドバイスに関する他のすべての情報を
ソースコードで明示します。
関数<CODE>ad-add-advice</CODE>を用いると、
その詳細を計算で求めたアドバイスを作成できます。
<P>

<A NAME="IDX804"></A>
<DL>
<DT><U>Function:</U> <B>ad-add-advice</B> <I>function advice class position</I>
<DD><CODE>ad-add-advice</CODE>を呼び出すと、
関数<VAR>function</VAR>に対するクラス<VAR>class</VAR>のアドバイス断片として
<VAR>advice</VAR>を追加する。
引数<VAR>advice</VAR>はつぎの形式である。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(<VAR>name</VAR> <VAR>protected</VAR> <VAR>enabled</VAR> <VAR>definition</VAR>)
</pre></td></tr></table><P>

ここで、<VAR>protected</VAR>と<VAR>enabled</VAR>はフラグであり、
<VAR>definition</VAR>はアドバイスの動作を指定する式である。
<VAR>enabled</VAR>が<CODE>nil</CODE>であると、
このアドバイス断片は当初は無効になる
（see 節 <A HREF="elisp_17.html#SEC214">16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM></A>）。
<P>

<VAR>function</VAR>に指定したクラス<VAR>class</VAR>のアドバイス断片がすでにあると、
<VAR>position</VAR>は新しいアドバイス断片をリストのどこに置くかを指定する。
<VAR>position</VAR>の値は、<CODE>first</CODE>、<CODE>last</CODE>、あるいは、
（リストの先頭を0から数えた）数である。
範囲外の数はその範囲の先頭か末尾のどちらか近いほうになる。また、
<VAR>position</VAR>の値はすでに存在するアドバイス断片を再定義した時には無視
される。
<P>

<VAR>function</VAR>に同じ名前のアドバイス断片<VAR>advice</VAR>がすでにあると、
引数<VAR>position</VAR>は無視され、古いアドバイス断片を新しいもので置き換える。
</DL>
<P>

<A NAME="Activation of Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC213"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC212"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC214"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Activation of Advice"></A>
<H2> 16.5 アドバイスの活性化 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC213::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Activation%20of%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Activation%20of%20Advice</a>"<br>
"texi/elisp21/アドバイスの活性化"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9%A4%CE%B3%E8%C0%AD%B2%BD">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<A NAME="IDX805"></A>
<A NAME="IDX806"></A>
<P>

デフォルトでは、アドバイスを定義してもその効果は発揮されません。
アドバイスした関数のアドバイスを<EM>活性</EM>にして始めて効果を発揮します。
<CODE>defadvice</CODE>でフラグ<CODE>activate</CODE>を指定すれば、
関数にアドバイスを定義したときに活性にできます。
しかし、普通は、関数<CODE>ad-activate</CODE>や以下の活性化コマンドを
呼び出すことで、関数のアドバイスを活性にします。
<P>

アドバイスの定義操作と活性化操作を区別することで、
アドバイスを追加するたびに関数を再定義することなる、
関数に複数のアドバイス断片を効率よく追加できます。
さらに重要なことは、関数を実際に定義するまえでも
関数にアドバイスを定義できることです。
<P>

関数のアドバイスを初めて活性にすると、
関数の元定義を保存してから、関数に対する有効なアドバイス断片すべてを
元定義と結合して新たな定義を作り出します。
（現在無効にしてあるアドバイス断片は使用しない。
see 節 <A HREF="elisp_17.html#SEC214">16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM></A>。）
この定義をインストールし、
以下に述べる条件に応じてバイトコンパイルする場合もあります。
<P>

アドバイスを活性にするコマンドすべてにおいて、
<VAR>compile</VAR>が<CODE>t</CODE>であると、
アドバイスを実装する結合定義をコンパイルします。
<P>

<A NAME="IDX807"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-activate</B> <I>function &#38;optional compile</I>
<DD>このコマンドは<VAR>function</VAR>に対するアドバイスを活性にする。
</DL>
<P>

<A NAME="IDX808"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-deactivate</B> <I>function</I>
<DD>このコマンドは<VAR>function</VAR>のアドバイスを不活性にする。
<A NAME="IDX809"></A>
<A NAME="IDX810"></A>
</DL>
<P>

<A NAME="IDX811"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-deactivate-all</B>
<DD>このコマンドはすべての関数に対するアドバイスを不活性にする。
</DL>
<P>

<A NAME="IDX812"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-update-all</B> <I>&#38;optional compile</I>
<DD>このコマンドは、すでにアドバイスが活性になっているすべて
の関数のアドバイスを活性化させる。いくつかの関数のアドバイスを変更した
時に役に立つ。
</DL>
<P>

<A NAME="IDX813"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-activate-regexp</B> <I>regexp &#38;optional compile</I>
<DD>このコマンドは<VAR>regexp</VAR>に一致する名前のすべてのアドバイス断片を活性にする。
より正確には、<VAR>regexp</VAR>に一致する名前のアドバイス断片を持つ任意の
関数のすべてのアドバイスを活性にする。
</DL>
<P>

<A NAME="IDX814"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-deactivate-regexp</B> <I>regexp</I>
<DD>このコマンドは<VAR>regexp</VAR>に一致する名前の
すべてのアドバイス断片を不活性にする。
より正確には、<VAR>regexp</VAR>に一致する名前のアドバイス断片を持つ任意の
関数のすべてのアドバイスを不活性にする。
</DL>
<P>

<A NAME="IDX815"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-update-regexp</B> <I>regexp &#38;optional compile</I>
<DD>このコマンドは<VAR>regexp</VAR>に一致する名前のアドバイス断片を活性にするが、
すでにアドバイスが活性になっている関数に対するものだけである。
<A NAME="IDX816"></A>
<P>

関数に対するアドバイスの再活性化は、
アドバイスを活性にしたあとに行った当該アドバイスの変更すべて
（有効にしたり無効にしたアドバイス断片を含む。
see 節 <A HREF="elisp_17.html#SEC214">16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM></A>）が効果を持つようにするのに便利である。
</DL>
<P>

<A NAME="IDX817"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-start-advice</B>
<DD>関数を定義したり再定義したときにアドバイスを自動的に活性にする。
このモードをオンにすると、アドバイスを定義するとただちに効果を持つようになる。
</DL>
<P>

<A NAME="IDX818"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-stop-advice</B>
<DD>関数を定義したり再定義してもアドバイスを自動的には活性にしない。
</DL>
<P>

<A NAME="IDX819"></A>
<DL>
<DT><U>User Option:</U> <B>ad-default-compilation-action</B>
<DD>この変数は、関数に対するアドバイスを活性にした結果作られる
結合定義をコンパイルするかどうか制御します。
<P>

値が<CODE>always</CODE>であれば、無条件にコンパイルします。<CODE>nil</CODE>であれば
常にコンパイルしない。
<P>

値が<CODE>maybe</CODE>であれば、バイトコンパイラがすでに読み込まれていればコ
ンパイルを行う。値が<CODE>like-original</CODE>であれば、アドバイスされる関数
の元定義がコンパイルされていたり、組み込み関数(built-in function)であ
れば、コンパイルを行う。
<P>

この変数は<CODE>ad-activate</CODE>(あるいは他の上記にあげた関数)の
<VAR>compile</VAR>引数が<CODE>nil</CODE>の場合のみ有効になります。もしその引数が
<CODE>nil</CODE>でなければ、そのアドバイスがこの変数の値に関わらずコンパイル
されます。
</DL>
<P>

『予約活性』（see 節 <A HREF="elisp_17.html#SEC215">16.7 予約活性 <EM>(2003/10/30)</EM></A>）中にアドバイス定義を作成すると
その定義はすでにコンパイルされているはずです。
というのは、<CODE>preactivate</CODE>フラグを指定した<CODE>defadvice</CODE>を
含むファイルをバイトコンパイル中にそれが定義されたはずだからです。
<P>

<A NAME="Enabling Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC214"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC213"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC215"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Enabling Advice"></A>
<H2> 16.6 アドバイスの有効化と無効化 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC214::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Enabling%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Enabling%20Advice</a>"<br>
"texi/elisp21/アドバイスの有効化と無効化"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9%A4%CE%CD%AD%B8%FA%B2%BD%A4%C8%CC%B5%B8%FA%B2%BD">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<A NAME="IDX820"></A>
<A NAME="IDX821"></A>
<A NAME="IDX822"></A>
<P>

各アドバイス断片には、
それを有効にするか無効にするかを指定するフラグがあります。
アドバイス断片を有効にしたり無効にすることで、
アドバイス断片を未定義にしたり再定義することなくオン／オフできます。
たとえば、関数<CODE>foo</CODE>に対するアドバイス断片<CODE>my-advice</CODE>を
無効にするには、つぎのようにします。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-disable-advice 'foo 'before 'my-advice)
</pre></td></tr></table><P>

この関数自身は、アドバイス断片の有効化フラグを変更するだけです。
アドバイスした関数でこの変更の効果を発揮するには、
<CODE>foo</CODE>のアドバイスを再度活性にする必要があります。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-activate 'foo)
</pre></td></tr></table><P>

<A NAME="IDX823"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-disable-advice</B> <I>function class name</I>
<DD>このコマンドは<VAR>function</VAR>に対するクラス<VAR>class</VAR>内の
<VAR>name</VAR>で指名したアドバイス断片を無効にする。
</DL>
<P>

<A NAME="IDX824"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-enable-advice</B> <I>function class name</I>
<DD>このコマンドは<VAR>function</VAR>に対するクラス<VAR>class</VAR>内の
<VAR>name</VAR>で指名したアドバイス断片を有効にする。
</DL>
<P>

正規表現を用いて、さまざまな関数に対する
多数のアドバイス断片を一度に無効にすることもできます。
この場合も、当該関数のアドバイスを再度活性にすることで、
その効果が発揮されます。
<P>

<A NAME="IDX825"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-disable-regexp</B> <I>regexp</I>
<DD>このコマンドは、すべての関数のすべてのクラスの
<VAR>regexp</VAR>に一致するアドバイス断片すべてを無効にする。
</DL>
<P>

<A NAME="IDX826"></A>
<DL>
<DT><U>コマンド:</U> <B>ad-enable-regexp</B> <I>regexp</I>
<DD>このコマンドは、すべての関数のすべてのクラスの
<VAR>regexp</VAR>に一致するアドバイス断片すべてを有効にする。
</DL>
<P>

<A NAME="Preactivation"></A>
<HR SIZE="6">
<br><A NAME="SEC215"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC214"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC216"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Preactivation"></A>
<H2> 16.7 予約活性 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC215::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Preactivation">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Preactivation</a>"<br>
"texi/elisp21/予約活性"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%CD%BD%CC%F3%B3%E8%C0%AD">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<A NAME="IDX827"></A>
<A NAME="IDX828"></A>
<P>

アドバイスを実行するための結合定義を作成することは、
ある程度手間がかかります。
ライブラリで多数の関数をアドバイスしていると、
ライブラリのロードが遅くなります。
そのような場合、あらかじめ適切な結合定義を作成する
<EM>予約活性</EM>（preactivation）を使えます。
<P>

予約活性を使うには、<CODE>defadvice</CODE>でアドバイスを定義するときに
フラグ<CODE>preactivate</CODE>を指定します。
このような<CODE>defadvice</CODE>の呼び出しでは、
（有効か無効に関わらず）このアドバイス断片と
当該関数に対して現在有効になっている他のアドバイスを元定義
に結合した定義を作成します。
<CODE>defadvice</CODE>をコンパイルすると、その結合定義もコンパイルします。
<P>

のちに関数のアドバイスを活性にしたとき、
関数に対する有効にしたアドバイスがこの結合定義の作成に
使用したものに一致すると既存の結合定義を使います。
そのため、新たに結合定義を作成する必要がなくなります。
したがって、予約活性はけっしてまちがった結果を生じませんが、
予約活性に用いたアドバイスと活性にした有効なアドバイスが一致しないと
利点はなくなります。
<P>

不一致のために予約活性が正しく動作していない兆候の例を示します。
<P>

<UL>
<LI>
アドバイスした関数の活性に通常より長くかかる。
<LI>
アドバイスした関数を活性にするとバイトコンパイラがロードされる。
<LI>
バイトコンパイラを意図して使っていないのに、
<CODE>features</CODE>の値に<CODE>byte-compile</CODE>が含まれる。
</UL>
<P>

関数自体が定義されるまえであってもコンパイル済みの予約活性したアドバイスは
正しく動作します。
しかし、予約活性したアドバイスを<EM>コンパイル</EM>するときには
関数は定義済みである必要があります。
<P>

予約活性したアドバイスが使われない理由を調べるよい方法はありません。
できることは、
関数のアドバイスを活性にするまえに、
（関数<CODE>trace-function-background</CODE>で）
関数<CODE>ad-cache-id-verification-code</CODE>をトレースすることです。
活性にしたあと、当該関数に対して<CODE>ad-cache-id-verification-code</CODE>が
返した値を調べます。
<CODE>verified</CODE>ならば予約活性したアドバイスが使われています。
これ以外の値は、アドバイスが不適切と判断された理由に関する情報を
与えます。
<P>

<STRONG>警告：</STRONG><CODE> </CODE>
予約活性が失敗する場合が1つ知られている。
現在のアドバイスの状態に一致しなくても、
あらかじめ作成した結合定義を使ってしまう。
これは、同一関数に対する同じクラスの同一名称であるが異なるアドバイス断片を
2つのパッケージで定義している場合に発生する。
このようなことは避けること。
<P>

<A NAME="Argument Access in Advice"></A>
<HR SIZE="6">
<br><A NAME="SEC216"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC215"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC217"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Argument Access in Advice"></A>
<H2> 16.8 アドバイスからの引数の参照 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC216::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Argument%20Access%20in%20Advice">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Argument%20Access%20in%20Advice</a>"<br>
"texi/elisp21/アドバイスからの引数の参照"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%A5%A2%A5%C9%A5%D0%A5%A4%A5%B9%A4%AB%A4%E9%A4%CE%B0%FA%BF%F4%A4%CE%BB%B2%BE%C8">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

アドバイス断片の本体からアドバイスする関数の引数を参照する
もっとも簡単な方法は、関数定義で用いているものと同じ名前を使うことです。
これには、元関数の引数の変数名を知る必要があります。
<P>

多くの場合、この単純な方法で十分ですが、欠点もあります。
アドバイス内に引数名を直接書き込むために、堅牢ではありません。
関数の元定義が変更されると、アドバイスは動作しません。
<P>

他の方法は、アドバイスそのものに引数リストを指定することです。
これは関数の元定義の引数名を知る必要はありませんが、制約もあります。
関数に対するすべてのアドバイスで同一の引数リストを使う必要があります。
なぜなら、すべてのアドバイスに実際に使われる引数リストは、
当該関数のアドバイス断片の最初のものだからです。
<P>

より堅牢な方法は、活性にするときに、
つまり、アドバイスを結合した定義を作成するときに
適切なフォームに展開されるマクロを使うことです。
参照用マクロは、関数の引数変数への実引数の分配方法に依存しない
実引数の位置で参照します。
Emacs Lispにおいては、引数の意味は引数リスト内での位置で決まるため、
これは堅牢です。
<P>

<A NAME="IDX829"></A>
<DL>
<DT><U>Macro:</U> <B>ad-get-arg</B> <I>position</I>
<DD>位置<VAR>position</VAR>にある実引数を返す。
</DL>
<P>

<A NAME="IDX830"></A>
<DL>
<DT><U>Macro:</U> <B>ad-get-args</B> <I>position</I>
<DD>位置<VAR>position</VAR>から始まる実引数のリストを返す。
</DL>
<P>

<A NAME="IDX831"></A>
<DL>
<DT><U>Macro:</U> <B>ad-set-arg</B> <I>position value</I>
<DD>位置<VAR>position</VAR>にある実引数の値を設定する。
</DL>
<P>

<A NAME="IDX832"></A>
<DL>
<DT><U>Macro:</U> <B>ad-set-args</B> <I>position value-list</I>
<DD>位置<VAR>position</VAR>から始まる実引数のリストに<VAR>value-list</VAR>を設定する。
</DL>
<P>

例を示します。
関数<CODE>foo</CODE>の定義はつぎのとおりであり、
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(defun foo (x y &#38;optional z &#38;rest r) ...)
</pre></td></tr></table><P>

つぎのように呼ばれるとします。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(foo 0 1 2 3 4 5 6)
</pre></td></tr></table><P>

そうすると、<CODE>foo</CODE>の本体では、
<VAR>x</VAR>は0、<VAR>y</VAR>は1、<VAR>z</VAR>は2、<VAR>r</VAR>は<CODE>(3 4 5 6)</CODE>です。
このとき、<CODE>ad-get-arg</CODE>や<CODE>ad-get-args</CODE>は、つぎの値を返します。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-get-arg 0) => 0
(ad-get-arg 1) => 1
(ad-get-arg 2) => 2
(ad-get-arg 3) => 3
(ad-get-args 2) => (2 3 4 5 6)
(ad-get-args 4) => (4 5 6)
</pre></td></tr></table><P>

この例では、引数に値を設定できます。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-set-arg 5 "five")
</pre></td></tr></table><P>

の効果は、6番目の引数を<CODE>"five"</CODE>に変更します。
<CODE>foo</CODE>の本体を実行するまえにこのアドバイスが実行されると、
本体内では<VAR>r</VAR>は<CODE>(3 4 "five" 6)</CODE>になります。
<P>

つぎは引数リストを変更する例です。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-set-args 0 '(5 4 3 2 1 0))
</pre></td></tr></table><P>

<CODE>foo</CODE>の本体を実行するまえにこのアドバイスが実行されると、
<CODE>foo</CODE>の本体内では、
<VAR>x</VAR>は5、<VAR>y</VAR>は4、<VAR>z</VAR>は3、<VAR>r</VAR>は<CODE>(2 1 0)</CODE>になります。
<P>

これらの引数参照は、実際にはLispマクロとしての実装ではありません。
アドバイス機構で特別に実装してあります。
<P>

<A NAME="Subr Arguments"></A>
<HR SIZE="6">
<br><A NAME="SEC217"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC216"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC218"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Subr Arguments"></A>
<H2> 16.9 subr引数リストの定義 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC217::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Subr%20Arguments">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Subr%20Arguments</a>"<br>
"texi/elisp21/subr引数リストの定義"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2Fsubr%B0%FA%BF%F4%A5%EA%A5%B9%A5%C8%A4%CE%C4%EA%B5%C1">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

アドバイス機能が結合定義を作成するとき、
元関数の引数リストを知る必要があります。
基本関数に対しては、これはつねに可能とは限りません。
アドバイスが引数リストを決定できないときには、
<CODE>(&#38;rest ad-subr-args)</CODE>を使います。
これはつねに動作しますが、
引数値のリストを作成するために効率的ではありません。
<CODE>ad-define-subr-args</CODE>を使って、
基本関数に対する適当な引数名を宣言できます。
<P>

<A NAME="IDX833"></A>
<DL>
<DT><U>Function:</U> <B>ad-define-subr-args</B> <I>function arglist</I>
<DD>この関数は、関数<VAR>function</VAR>の引数リストとして
<VAR>arglist</VAR>を使うことを指定する。
</DL>
<P>

たとえば、
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(ad-define-subr-args 'fset '(sym newdef))
</pre></td></tr></table><P>

は、関数<CODE>fset</CODE>の引数リストを指定します。
<P>

<A NAME="Combined Definition"></A>
<HR SIZE="6">
<br><A NAME="SEC218"> </A>
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_17.html#SEC217"> &lt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_18.html#SEC219"> &gt; </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top"> Up </A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<A NAME="Combined Definition"></A>
<H2> 16.10 結合定義 <EM>(2003/10/30)</EM> </H2>
<!--docid::SEC218::-->
<div class="info">URL="<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Combined%20Definition">http://www.bookshelf.jp/cgi-bin/goto.cgi?file=elisp21&node=Combined%20Definition</a>"<br>
"texi/elisp21/結合定義"への<a href="http://www.bookshelf.jp/pukiwiki/pukiwiki.php?refer=Meadow%20memo&cmd=read&page=texi%2Felisp21%2F%B7%EB%B9%E7%C4%EA%B5%C1">コメント</a>(無し)</div><FORM METHOD="GET" ACTION="http://www.bookshelf.jp/cgi-bin/wwwsrch.cgi"><div class="info">検索<INPUT TYPE=text NAME=WORD SIZE=30><INPUT TYPE=hidden NAME=index VALUE=memo CHECKED><INPUT TYPE=hidden NAME=target VALUE=all CHECKED><INPUT TYPE=hidden NAME="memoall" VALUE="on" CHECKED><INPUT TYPE=hidden NAME=ANDOR VALUE=and CHECKED><INPUT TYPE=radio NAME=lisp VALUE=off CHECKED>全文<INPUT TYPE=radio NAME=lisp VALUE=on>Elisp<INPUT TYPE=submit VALUE="検索"></div></FORM>
<P>

関数には、<VAR>n</VAR>個(0から<VAR>n</VAR>-1として数えられる)の事前アドバイス（before-advice）、
<VAR>m</VAR>個の包囲アドバイス（around-advice）、
<VAR>k</VAR>個の事後アドバイス（after-advice）があるとします。
保護したアドバイス断片はないと仮定すると、
関数のアドバイスを実装するために作成される結合定義は
つぎのようになります。
<P>

<TABLE><tr><td>&nbsp;</td><td class=example><pre>(lambda <VAR>arglist</VAR>
  [ [<VAR>advised-docstring</VAR>] [(interactive ...)] ]
  (let (ad-return-value)
    before-0-body-form...
         ....
    before-<VAR>n</VAR>-1-body-form...
    around-0-body-form...
       around-1-body-form...
             ....
          around-<VAR>m</VAR>-1-body-form...
             (setq ad-return-value
                   apply original definition to <VAR>arglist</VAR>)
          end-of-around-<VAR>m</VAR>-1-body-form...
             ....
       end-of-around-1-body-form...
    end-of-around-0-body-form...
    after-0-body-form...
          ....
    after-<VAR>k</VAR>-1-body-form...
    ad-return-value))
</pre></td></tr></table><P>

マクロはマクロとして再定義します。
つまり、結合定義の先頭に<CODE>macro</CODE>を追加します。
<P>

元関数やアドバイス断片のどれかに対話宣言があれば、
対話宣言フォームが入ります。
対話的な基本関数をアドバイスした場合には、
アドバイスは特別な方法を使います。
つまり、基本関数を<CODE>call-interactively</CODE>で呼び出して、
基本関数自身が引数を読み取るようにします。
この場合、アドバイスからは引数を参照できません。
<P>

各クラスのさまざまなアドバイスの本体フォームは、
それらの指定された順に組み立てられます。
包囲アドバイス<VAR>l</VAR>（around-advice <VAR>l</VAR>）のフォーム群は、
包囲アドバイス<VAR>l</VAR> - 1（around-advice <VAR>l</VAR> - 1）の
フォームの1つに入ります。
<P>

包囲アドバイスのもっとも内側では、
<P>

<TABLE><tr><td>&nbsp;</td><td class=display><pre style="font-family: serif">元定義を<VAR>arglist</VAR>に適用
</pre></td></tr></table><P>

しますが、そのフォームは元関数の種類に依存します。
変数<CODE>ad-return-value</CODE>には、その戻り値が設定されます。
この変数はすべてのアドバイス断片から見えるので、
アドバイスした関数から実際に戻るまえに、
これを参照したり変更できます。
<P>

保護したアドバイス断片を含むアドバイスした関数の構造も同じです。
唯一の違いは、フォーム<CODE>unwind-protect</CODE>により、
アドバイス断片でエラーを起こしたり非ローカル脱出を行っても、
保護したアドバイスが実行されることを保証します。
包囲アドバイスを1つでも保護していると、その結果として、
包囲アドバイス全体が保護されます。
<P>

<A NAME="Debugging"></A>
<HR SIZE="6">
<TABLE CELLPADDING=1 CELLSPACING=1 BORDER=0>
<TR><TD VALIGN="MIDDLE" ALIGN="LEFT">[ &lt;&lt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[ &gt;&gt; ]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT"> &nbsp; <TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp.html#SEC_Top">表紙</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_toc.html#SEC_Contents">目次</A>]</TD>
<TD VALIGN="MIDDLE" ALIGN="LEFT">[<A HREF="elisp_48.html#SEC681">索引</A>]</TD>
<TD> [<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=search">検索</a>] [<a href="#top">上端</a> / <a href="#bottom">下端</a>]</TD></TR></TABLE>
<a name="bottom"> </a>
<script type="text/javascript" src="style2.js"></script>
<div class="footer">
    <br>
    このページはMeadow (Emacs) の紹介ページです <br>
このWebページの各文書は自由にリンク・複製・再配布・改変していただいて構いません．
<br>ただし，複製・再配布・改変の場合は Meadow Memo のURLを記載しておいて下さい．<br>
<a href="http://www.bookshelf.jp/cgi-bin/goto.cgi?file=meadow&node=about%20link">Medow memoへのリンクについて</a>．<br>

間違い，要望等があれば<a href="mailto:akihisa@mail.ne.jp">akihisa@mail.ne.jp</a> か下記でどうぞ<br>

<br>

<FORM METHOD="post" ACTION="http://www.bookshelf.jp/cgi-bin/wwwmail.cgi" >
お名前：<INPUT TYPE="text" NAME="name" SIZE="30" MAXLENGTH="40" VALUE="ななしさん"><br>
メールアドレス：<INPUT TYPE="text" NAME="EMAIL" SIZE="25" MAXLENGTH="60" VALUE="secret@mail.adr"><br>
<input type="hidden" name="HPAGE" value="">
つっこみ：<br><TEXTAREA NAME="MESSAGE" ROWS="5" COLS="50">
</TEXTAREA><br><br>
<INPUT TYPE="submit" VALUE="送信">
<INPUT TYPE="reset" VALUE="クリア">
</FORM>

<br><A HREF="http://www.bookshelf.jp/cgi-bin/xct.cgi">ページ別カウンタ</a>
<br> Since 2002/12/13 <br>
</div>

</BODY>

</HTML>
